{% extends '../base.html' %}
{% block content %}
{% include './navbar.html' %}
{% include './sidebar.html' %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<div class="p-8 sm:ml-64 mt-14">
    <div x-data="communityDiscussion()" class="container mx-auto">
        <h1 class="text-3xl font-bold mb-6">Community Discussion</h1>

        <!-- Search and Filters -->
        <div class="mb-6 flex flex-col md:flex-row gap-4">
            <input 
                x-model="searchTerm" 
                type="text" 
                placeholder="Search discussions..." 
                class="flex-grow p-2 border rounded-lg"
            >
            <select 
                x-model="selectedCategory" 
                class="p-2 border rounded-lg"
            >
                <option value="all">All Categories</option>
                <option value="general">General</option>
                <option value="support">Support</option>
                <option value="offtopic">Off-Topic</option>
            </select>
            <select 
                x-model="sortOrder" 
                class="p-2 border rounded-lg"
            >
                <option value="latest">Latest</option>
                <option value="oldest">Oldest</option>
                <option value="mostReplies">Most Replies</option>
            </select>
        </div>

        <!-- Discussion Threads -->
        <div class="space-y-6">
            <template x-for="thread in filteredThreads" :key="thread.id">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-xl font-semibold" x-text="thread.title"></h2>
                        <span 
                            class="px-2 py-1 text-sm rounded-full" 
                            :class="{
                                'bg-blue-100 text-blue-800': thread.category === 'general',
                                'bg-green-100 text-green-800': thread.category === 'support',
                                'bg-purple-100 text-purple-800': thread.category === 'offtopic'
                            }"
                            x-text="thread.category"
                        ></span>
                    </div>
                    <p class="text-gray-600 mb-4" x-text="thread.content"></p>
                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <span x-text="`Posted by ${thread.author} on ${formatDate(thread.date)}`"></span>
                        <span x-text="`${thread.replies.length} replies`"></span>
                    </div>

                    <!-- Replies -->
                    <div class="mt-6 space-y-4">
                        <template x-for="reply in thread.replies.slice(0, thread.showAllReplies ? undefined : 2)" :key="reply.id">
                            <div class="bg-gray-50 rounded p-4">
                                <p class="mb-2" x-text="reply.content"></p>
                                <div class="text-sm text-gray-500">
                                    <span x-text="`Reply by ${reply.author} on ${formatDate(reply.date)}`"></span>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Show More Replies -->
                    <template x-if="thread.replies.length > 2 && !thread.showAllReplies">
                        <button 
                            @click="thread.showAllReplies = true"
                            class="mt-4 text-green-600 hover:underline"
                        >
                            Show all replies
                        </button>
                    </template>

                    <!-- Add Reply -->
                    <div class="mt-6">
                        <textarea 
                            x-model="thread.newReply" 
                            placeholder="Write a reply..." 
                            class="w-full p-2 border rounded-lg"
                        ></textarea>
                        <button 
                            @click="addReply(thread)"
                            class="mt-2 bg-green-500 text-white rounded-lg py-2 px-4 hover:bg-green-600"
                        >
                            Post Reply
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- New Thread Button -->
        <button 
            @click="showNewThreadModal = true"
            class="fixed bottom-6 right-6 bg-green-500 text-white rounded-full p-4 shadow-lg hover:bg-green-600"
        >
            <i class="fas fa-plus"></i>
        </button>

        <!-- New Thread Modal -->
        <div x-show="showNewThreadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Create New Thread</h2>
                <input 
                    x-model="newThread.title" 
                    type="text" 
                    placeholder="Thread Title" 
                    class="w-full p-2 border rounded-lg mb-4"
                >
                <textarea 
                    x-model="newThread.content" 
                    placeholder="Thread Content" 
                    class="w-full p-2 border rounded-lg mb-4"
                    rows="4"
                ></textarea>
                <select 
                    x-model="newThread.category" 
                    class="w-full p-2 border rounded-lg mb-4"
                >
                    <option value="general">General</option>
                    <option value="support">Support</option>
                    <option value="offtopic">Off-Topic</option>
                </select>
                <div class="flex justify-end">
                    <button 
                        @click="showNewThreadModal = false"
                        class="bg-gray-300 text-black rounded-lg py-2 px-4 mr-2 hover:bg-gray-400"
                    >
                        Cancel
                    </button>
                    <button 
                        @click="createNewThread"
                        class="bg-green-500 text-white rounded-lg py-2 px-4 hover:bg-green-600"
                    >
                        Create Thread
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function communityDiscussion() {
            return {
                threads: [
                    {
                        id: 1,
                        title: "Welcome to our community!",
                        content: "Hello everyone! This is a place for us to discuss various topics and help each other out.",
                        author: "Admin",
                        date: new Date(2024, 6, 1),
                        category: "general",
                        replies: [
                            { id: 1, content: "Glad to be here!", author: "User1", date: new Date(2024, 6, 1, 12, 30) },
                            { id: 2, content: "Looking forward to great discussions!", author: "User2", date: new Date(2024, 6, 1, 13, 45) },
                        ],
                        showAllReplies: false,
                        newReply: ""
                    },
                    {
                        id: 2,
                        title: "Need help with my homework",
                        content: "I'm struggling with calculus. Can anyone recommend good resources?",
                        author: "Student123",
                        date: new Date(2024, 6, 5),
                        category: "support",
                        replies: [
                            { id: 3, content: "Khan Academy has great calculus tutorials!", author: "MathWhiz", date: new Date(2024, 6, 5, 16, 20) },
                        ],
                        showAllReplies: false,
                        newReply: ""
                    },
                    {
                        id: 3,
                        title: "Movie recommendations?",
                        content: "What's everyone's favorite sci-fi movie? I need something to watch this weekend!",
                        author: "FilmBuff",
                        date: new Date(2024, 6, 10),
                        category: "offtopic",
                        replies: [
                            { id: 4, content: "Inception is a must-watch!", author: "DreamExplorer", date: new Date(2024, 6, 10, 20, 15) },
                            { id: 5, content: "I'd recommend The Matrix trilogy.", author: "RedPill", date: new Date(2024, 6, 11, 9, 30) },
                            { id: 6, content: "Interstellar blew my mind!", author: "SpaceNerd", date: new Date(2024, 6, 11, 14, 45) },
                        ],
                        showAllReplies: false,
                        newReply: ""
                    }
                ],
                searchTerm: '',
                selectedCategory: 'all',
                sortOrder: 'latest',
                showNewThreadModal: false,
                newThread: {
                    title: '',
                    content: '',
                    category: 'general'
                },
                get filteredThreads() {
                    let filtered = this.threads;
                    
                    if (this.searchTerm) {
                        const lowercaseSearch = this.searchTerm.toLowerCase();
                        filtered = filtered.filter(thread => 
                            thread.title.toLowerCase().includes(lowercaseSearch) || 
                            thread.content.toLowerCase().includes(lowercaseSearch)
                        );
                    }
                    
                    if (this.selectedCategory !== 'all') {
                        filtered = filtered.filter(thread => thread.category === this.selectedCategory);
                    }
                    
                    switch (this.sortOrder) {
                        case 'oldest':
                            filtered.sort((a, b) => a.date - b.date);
                            break;
                        case 'mostReplies':
                            filtered.sort((a, b) => b.replies.length - a.replies.length);
                            break;
                        default: // 'latest'
                            filtered.sort((a, b) => b.date - a.date);
                    }
                    
                    return filtered;
                },
                formatDate(date) {
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                },
                addReply(thread) {
                    if (thread.newReply.trim()) {
                        thread.replies.push({
                            id: Date.now(),
                            content: thread.newReply,
                            author: "CurrentUser", // In a real app, this would be the logged-in user
                            date: new Date()
                        });
                        thread.newReply = "";
                    }
                },
                createNewThread() {
                    if (this.newThread.title.trim() && this.newThread.content.trim()) {
                        this.threads.unshift({
                            id: Date.now(),
                            title: this.newThread.title,
                            content: this.newThread.content,
                            author: "CurrentUser", // In a real app, this would be the logged-in user
                            date: new Date(),
                            category: this.newThread.category,
                            replies: [],
                            showAllReplies: false,
                            newReply: ""
                        });
                        this.showNewThreadModal = false;
                        this.newThread = { title: '', content: '', category: 'general' };
                    }
                }
            }
        }
    </script>
</div>    

{% endblock %}